<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>加速度センサー デモ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 500px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
            font-weight: 600;
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 25px;
            font-size: 14px;
        }

        /* デバッグ情報トグル */
        .debug-toggle {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.1);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            cursor: pointer;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .debug-toggle:hover {
            background: rgba(0, 0, 0, 0.2);
        }

        .debug-info {
            display: none;
            background: #f8f8f8;
            border: 1px solid #ddd;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            font-size: 12px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 200px;
            overflow-y: auto;
        }

        .debug-info.active {
            display: block;
        }

        /* タブシステム */
        .tabs {
            display: flex;
            margin-bottom: 25px;
            background: #f0f0f0;
            border-radius: 12px;
            padding: 4px;
        }

        .tab {
            flex: 1;
            padding: 12px;
            text-align: center;
            border: none;
            background: transparent;
            cursor: pointer;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            color: #666;
        }

        .tab.active {
            background: white;
            color: #333;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .tab:hover:not(.active) {
            background: rgba(255, 255, 255, 0.5);
        }

        /* タブコンテンツ */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* ステータス */
        .status {
            text-align: center;
            padding: 12px;
            margin-bottom: 20px;
            border-radius: 10px;
            font-weight: 500;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .status.waiting {
            background: #e3f2fd;
            color: #1976d2;
        }

        .status.success {
            background: #e8f5e9;
            color: #388e3c;
        }

        .status.error {
            background: #ffebee;
            color: #d32f2f;
        }

        /* スタートボタン */
        .start-button {
            display: block;
            width: 100%;
            padding: 16px;
            font-size: 18px;
            font-weight: 600;
            color: white;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 12px;
            cursor: pointer;
            margin-bottom: 25px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            transition: all 0.3s ease;
        }

        .start-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .start-button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* センサーデータ表示 */
        .sensor-data {
            display: none;
        }

        .sensor-data.active {
            display: block;
        }

        /* === タブ1: 傾きセンサー === */

        /* 3Dデバイス表示 */
        .device-visualizer {
            margin: 30px auto;
            width: 200px;
            height: 200px;
            perspective: 800px;
        }

        .device-3d {
            width: 100%;
            height: 100%;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.1s ease-out;
        }

        .device-face {
            position: absolute;
            width: 120px;
            height: 180px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: 2px solid rgba(255, 255, 255, 0.8);
            border-radius: 15px;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 60px;
            color: rgba(255, 255, 255, 0.9);
            box-shadow: 0 0 30px rgba(102, 126, 234, 0.5);
        }

        /* 軸ごとのデータ表示 */
        .axis-container {
            margin-bottom: 20px;
        }

        .axis-item {
            margin-bottom: 20px;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .axis-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .axis-label {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
            font-size: 18px;
        }

        .axis-icon {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            font-size: 16px;
        }

        .axis-x .axis-icon {
            background: #e74c3c;
        }

        .axis-y .axis-icon {
            background: #2ecc71;
        }

        .axis-z .axis-icon {
            background: #3498db;
        }

        .axis-value {
            font-size: 20px;
            font-weight: 700;
            font-variant-numeric: tabular-nums;
        }

        /* プログレスバー */
        .progress-container {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
            position: relative;
        }

        .progress-bar {
            height: 100%;
            background: currentColor;
            transition: width 0.1s ease-out;
            position: absolute;
            left: 50%;
            transform-origin: left center;
        }

        .axis-x .progress-bar {
            background: #e74c3c;
        }

        .axis-y .progress-bar {
            background: #2ecc71;
        }

        .axis-z .progress-bar {
            background: #3498db;
        }

        /* 説明テキスト */
        .axis-description {
            font-size: 12px;
            color: #666;
            margin-top: 8px;
        }

        /* 傾き方向インジケーター */
        .tilt-indicator {
            margin: 20px auto;
            width: 150px;
            height: 150px;
            position: relative;
            background: #f0f0f0;
            border-radius: 50%;
            box-shadow: inset 0 0 20px rgba(0, 0, 0, 0.1);
        }

        .tilt-bubble {
            position: absolute;
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.5);
            transition: all 0.1s ease-out;
        }

        /* === タブ2: ダウジング === */

        .dowsing-container {
            text-align: center;
        }

        .pendulum-container {
            margin: 20px auto;
            width: 350px;
            height: 350px;
            position: relative;
            perspective: 800px;
        }

        /* ダウジングチャート */
        .dowsing-chart {
            position: absolute;
            width: 350px;
            height: 350px;
            left: 0;
            top: 135px;
            transform: rotateX(60deg);
            transform-style: preserve-3d;
        }

        .chart-circle {
            position: absolute;
            width: 100%;
            height: 100%;
            border: 4px solid #667eea;
            border-radius: 50%;
            background: radial-gradient(circle at center,
                    rgba(255, 255, 255, 0.95) 0%,
                    rgba(240, 243, 255, 0.9) 40%,
                    rgba(230, 235, 255, 0.85) 100%);
            box-shadow:
                0 10px 30px rgba(102, 126, 234, 0.2),
                inset 0 2px 10px rgba(102, 126, 234, 0.1);
        }

        .chart-center {
            position: absolute;
            width: 8px;
            height: 8px;
            background: #667eea;
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 0 10px rgba(102, 126, 234, 0.5);
        }

        /* ペンデュラム */
        .pendulum {
            position: absolute;
            left: 50%;
            top: 10%;
            transform: translateX(-50%);
            transform-style: preserve-3d;
            z-index: 10;
        }

        .pendulum-anchor {
            position: absolute;
            width: 10px;
            height: 10px;
            background: radial-gradient(circle, #666 0%, #444 100%);
            border-radius: 50%;
            left: 50%;
            top: 0;
            transform: translateX(-50%);
            z-index: 2;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .pendulum-chain {
            position: absolute;
            width: 1px;
            height: 220px;
            left: 50%;
            top: 5px;
            transform: translateX(-50%);
            transform-origin: top center;
            transform-style: preserve-3d;
        }

        .pendulum-chain::before {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            background: linear-gradient(180deg,
                    rgba(200, 200, 200, 0.8) 0%,
                    rgba(150, 150, 150, 0.9) 50%,
                    rgba(100, 100, 100, 1) 100%);
            box-shadow: 0 0 2px rgba(0, 0, 0, 0.2);
        }

        .pendulum-weight {
            position: absolute;
            width: 40px;
            height: 50px;
            background: linear-gradient(145deg,
                    #9b59b6 0%,
                    #8e44ad 30%,
                    #6c3483 60%,
                    #5b2c6f 100%);
            border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%;
            left: 50%;
            top: 100%;
            /* 鎖の末端におもりの上部を接続 */
            transform: translateX(-50%);
            box-shadow:
                0 8px 20px rgba(107, 52, 131, 0.4),
                inset 0 -3px 8px rgba(0, 0, 0, 0.2),
                inset 0 2px 6px rgba(255, 255, 255, 0.3);
            z-index: -1;
            /* 鎖が手前に来るように調整 */
        }

        .pendulum-weight::before {
            content: '';
            position: absolute;
            width: 15px;
            height: 15px;
            background: radial-gradient(circle at 30% 30%,
                    rgba(255, 255, 255, 0.8) 0%,
                    rgba(255, 255, 255, 0.4) 40%,
                    transparent 70%);
            border-radius: 50%;
            top: 8px;
            left: 8px;
        }

        .pendulum-weight::after {
            content: '';
            position: absolute;
            width: 12px;
            height: 12px;
            background: radial-gradient(circle,
                    rgba(255, 255, 255, 0) 0%,
                    rgba(255, 255, 255, 0.2) 50%,
                    rgba(255, 255, 255, 0) 100%);
            border-radius: 50%;
            bottom: 5px;
            right: 5px;
            animation: sparkle 2s infinite;
        }

        @keyframes sparkle {

            0%,
            100% {
                opacity: 0.5;
            }

            50% {
                opacity: 1;
            }
        }

        .pendulum-shadow {
            position: absolute;
            width: 60px;
            height: 30px;
            background: radial-gradient(ellipse at center,
                    rgba(0, 0, 0, 0.4) 0%,
                    rgba(0, 0, 0, 0.2) 40%,
                    transparent 70%);
            top: 300px;
            left: 50%;
            transform: translateX(-50%) rotateX(90deg);
            filter: blur(2px);
        }

        @keyframes pulse {

            0%,
            100% {
                transform: translate(-50%, -50%) scale(1);
                opacity: 0.3;
            }

            50% {
                transform: translate(-50%, -50%) scale(1.1);
                opacity: 0.6;
            }
        }


        .detection-meter {
            margin: 150px auto 30px auto;
            width: 250px;
        }

        .meter-label {
            text-align: center;
            font-weight: 600;
            margin-bottom: 10px;
            color: #333;
        }

        .meter-container {
            background: #f0f0f0;
            height: 20px;
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }

        .meter-fill {
            height: 100%;
            background: linear-gradient(90deg, #2ecc71 0%, #f39c12 50%, #e74c3c 100%);
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 10px;
        }

        .meter-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 12px;
            font-weight: bold;
            color: #333;
        }

        .detection-status {
            margin: 20px 0;
            padding: 15px;
            border-radius: 10px;
            font-weight: 600;
            text-align: center;
            transition: all 0.3s ease;
        }

        .detection-status.none {
            background: #f8f9fa;
            color: #666;
        }

        .detection-status.weak {
            background: #e8f5e9;
            color: #2ecc71;
        }

        .detection-status.strong {
            background: #fff3cd;
            color: #f39c12;
        }

        .detection-status.very-strong {
            background: #ffebee;
            color: #e74c3c;
            animation: glow 1s infinite alternate;
        }

        @keyframes glow {
            from {
                box-shadow: 0 0 10px rgba(231, 76, 60, 0.3);
            }

            to {
                box-shadow: 0 0 20px rgba(231, 76, 60, 0.6);
            }
        }

        .info {
            font-size: 13px;
            color: #666;
            text-align: center;
            margin-top: 20px;
            line-height: 1.6;
        }

        /* 感度調整スライダー */
        .sensitivity-control {
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .sensitivity-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            font-weight: 600;
            font-size: 14px;
        }

        .sensitivity-value {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .sensitivity-slider {
            width: 100%;
            height: 8px;
            -webkit-appearance: none;
            appearance: none;
            background: #e0e0e0;
            border-radius: 4px;
            outline: none;
            transition: all 0.3s ease;
        }

        .sensitivity-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
            transition: all 0.3s ease;
        }

        .sensitivity-slider::-webkit-slider-thumb:hover {
            transform: scale(1.2);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.5);
        }

        .sensitivity-slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
            transition: all 0.3s ease;
            border: none;
        }

        .sensitivity-slider::-moz-range-thumb:hover {
            transform: scale(1.2);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.5);
        }

        .sensitivity-description {
            font-size: 12px;
            color: #666;
            margin-top: 8px;
            text-align: center;
        }

        /* === タブ3: 真上から見る === */
        .top-down-visualizer {
            margin: 30px auto;
            width: 300px;
            height: 300px;
            position: relative;
            background: #f0f0f0;
            border-radius: 50%;
            border: 2px solid #ccc;
            box-shadow: inset 0 0 20px rgba(0, 0, 0, 0.1);
        }

        .top-down-visualizer::before,
        .top-down-visualizer::after {
            content: '';
            position: absolute;
            background: #ddd;
        }

        .top-down-visualizer::before {
            /* Horizontal line */
            width: 100%;
            height: 1px;
            top: 50%;
            left: 0;
        }

        .top-down-visualizer::after {
            /* Vertical line */
            width: 1px;
            height: 100%;
            top: 0;
            left: 50%;
        }

        .top-down-chain {
            position: absolute;
            top: 0;
            left: 0;
            pointer-events: none;
            z-index: 2;
        }

        .top-down-bubble {
            position: absolute;
            width: 30px;
            height: 30px;
            background: linear-gradient(145deg,
                    #9b59b6 0%,
                    #8e44ad 30%,
                    #6c3483 60%,
                    #5b2c6f 100%);
            border-radius: 50%;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 4px 15px rgba(107, 52, 131, 0.5);
            transition: all 0.1s ease-out;
            z-index: 1;
        }

        /* モードごとの説明 */
        .mode-instruction {
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: center;
        }

        .mode-instruction p {
            font-size: 13px;
            color: #333;
            line-height: 1.6;
            margin-bottom: 10px;
        }

        .instruction-diagram {
            font-family: monospace;
            font-size: 12px;
            color: #666;
            background: #fff;
            padding: 10px;
            border-radius: 8px;
            white-space: pre;
            display: inline-block;
            border: 1px solid #eee;
        }
    </style>
</head>

<body>
    <div class="container">
        <button id="debugToggle" class="debug-toggle" title="デバッグ情報">
            🔧
        </button>

        <h1>📱 加速度センサー デモ</h1>
        <p class="subtitle">タブを切り替えて様々なデモを体験</p>

        <div id="debugInfo" class="debug-info">
            デバッグ情報がここに表示されます...
        </div>

        <div class="tabs">
            <button class="tab" data-tab="tilt">🔄 傾きセンサー</button>
            <button class="tab active" data-tab="dowsing">🪄 ダウジング</button>
            <button class="tab" data-tab="topDown">🔭 真上から見る</button>
        </div>

        <div id="status" class="status waiting">
            開始ボタンをタップしてください
        </div>

        <button id="startButton" class="start-button">
            センサーを開始
        </button>

        <div class="sensitivity-control">
            <div class="sensitivity-label">
                <span>🎚️ 感度調整</span>
                <span class="sensitivity-value" id="sensitivityValue">x2.0</span>
            </div>
            <input type="range" class="sensitivity-slider" id="sensitivitySlider" min="0.5" max="25" step="0.1"
                value="2">
            <div class="sensitivity-description">
                低感度 ← → 高感度
            </div>
        </div>

        <div id="tiltContent" class="tab-content">
            <div id="sensorData" class="sensor-data">
                <div class="device-visualizer">
                    <div id="device3d" class="device-3d">
                        <div class="device-face">📱</div>
                    </div>
                </div>

                <div class="tilt-indicator">
                    <div id="tiltBubble" class="tilt-bubble"></div>
                </div>

                <div class="axis-container">
                    <div class="axis-item axis-x">
                        <div class="axis-header">
                            <div class="axis-label">
                                <div class="axis-icon">X</div>
                                <span>左右の傾き</span>
                            </div>
                            <div class="axis-value" id="xValue">0.00</div>
                        </div>
                        <div class="progress-container">
                            <div id="xProgress" class="progress-bar"></div>
                        </div>
                        <div class="axis-description">左に傾ける ← → 右に傾ける</div>
                    </div>

                    <div class="axis-item axis-y">
                        <div class="axis-header">
                            <div class="axis-label">
                                <div class="axis-icon">Y</div>
                                <span>前後の傾き</span>
                            </div>
                            <div class="axis-value" id="yValue">0.00</div>
                        </div>
                        <div class="progress-container">
                            <div id="yProgress" class="progress-bar"></div>
                        </div>
                        <div class="axis-description">手前に傾ける ← → 奥に傾ける</div>
                    </div>

                    <div class="axis-item axis-z">
                        <div class="axis-header">
                            <div class="axis-label">
                                <div class="axis-icon">Z</div>
                                <span>上下の動き</span>
                            </div>
                            <div class="axis-value" id="zValue">0.00</div>
                        </div>
                        <div class="progress-container">
                            <div id="zProgress" class="progress-bar"></div>
                        </div>
                        <div class="axis-description">下向き ← → 上向き</div>
                    </div>
                </div>
            </div>
        </div>

        <div id="dowsingContent" class="tab-content active">
            <div id="dowsingData" class="sensor-data dowsing-container">
                <div class="pendulum-container">
                    <div class="dowsing-chart">
                        <div class="chart-circle">
                            <div class="chart-center"></div>
                        </div>
                    </div>

                    <div class="pendulum-anchor"></div>
                    <div id="pendulumChain" class="pendulum-chain">
                        <div class="pendulum-weight"></div>
                    </div>
                    <div id="pendulumShadow" class="pendulum-shadow"></div>
                </div>
            </div>

            <div class="detection-meter">
                <div class="meter-label">探知レベル</div>
                <div class="meter-container">
                    <div id="meterFill" class="meter-fill"></div>
                    <div id="meterText" class="meter-text">0%</div>
                </div>
            </div>

            <div id="detectionStatus" class="detection-status none">
                何も検出されていません
            </div>
        </div>
    </div>

    <div id="topDownContent" class="tab-content">
        <div id="topDownData" class="sensor-data">
            <div class="top-down-visualizer" id="topDownVisualizer">
                <svg class="top-down-chain" id="topDownChain" width="300" height="300">
                    <line id="topDownLine" x1="150" y1="150" x2="150" y2="150" stroke="#999" stroke-width="2"
                        opacity="0.7" />
                </svg>
                <div id="topDownBubble" class="top-down-bubble"></div>
            </div>
            <div class="info">
                💡 ペンデュラムの動きを真上から見た図です。<br>
                揺れの方向と大きさが分かります。
            </div>
        </div>
    </div>


    <div class="info">
        💡 デバイスを様々な方向に動かしてみてください<br>
        更新頻度: 100ms
    </div>
    </div>

    <script>
        // グローバル変数
        let debugLog = [];
        let isListening = false;
        let debugVisible = false;
        let currentTab = 'dowsing'; // デフォルトをダウジングに変更

        // 加速度データの履歴（ダウジング用）
        let linearAccelerationHistory = []; // 線形加速度の履歴を保存
        let detectionLevel = 0;

        // 感度設定
        let sensitivity = 2.0;
        let tiltSensitivity = 1.0;

        // ペンデュラムの物理状態
        let pendulumAngleX = 0;   // X軸周りの角度 (deg)
        let pendulumAngleY = 0;   // Y軸周りの角度 (deg)
        let pendulumAngleZ = 0;   // Z軸周りの角度（捻り）(deg)
        let pendulumVelocityX = 0;  // X軸周りの角速度
        let pendulumVelocityY = 0;  // Y軸周りの角速度
        let pendulumVelocityZ = 0;  // Z軸周りの角速度
        let pendulumForceX = 0;     // X軸方向の外力
        let pendulumForceY = 0;     // Y軸方向の外力
        let pendulumForceZ = 0;     // Z軸方向の外力

        // 加速度から重力を分離するための変数
        let gravity = { x: 0, y: 0, z: 0 };
        const LPF_ALPHA = 0.8; // ローパスフィルタの係数（大きいほど滑らか）

        // 減衰振動モデル (F = -kx - cv) に基づく定数
        const SPRING_CONSTANT = 0.02; // 復元力係数 (k) - 振り子を中央に戻す力
        const BASE_DAMPING = 0.98;   // 基本減衰係数 (c) - 動きを止める力（空気抵抗など）
        const BASE_MAX_ANGLE = 60;    // 基本最大振れ角 (deg)

        // 静止状態の検出と中心への引力に関する定数
        let stillnessCounter = 0;
        const STILLNESS_THRESHOLD = 15; // このフレーム数以上、動きが少なければ静止とみなす
        const MOVEMENT_THRESHOLD = 0.05; // この角速度以下を「動きが少ない」とみなす
        const CENTER_PULL_FORCE = 0.005; // 中心に引き寄せる力の係数

        // デバッグ情報を画面に表示
        function log(message) {
            const now = new Date().toTimeString().split(' ')[0];
            const logMessage = `[${now}] ${message}`;
            debugLog.push(logMessage);
            if (debugLog.length > 10) {
                debugLog.shift();
            }
            document.getElementById('debugInfo').textContent = debugLog.join('\n');
            console.log(logMessage);
        }

        // デバッグ表示切り替え
        document.getElementById('debugToggle').addEventListener('click', function () {
            debugVisible = !debugVisible;
            document.getElementById('debugInfo').classList.toggle('active', debugVisible);
            this.textContent = debugVisible ? '✖️' : '🔧';
        });

        // 感度スライダーのイベント
        document.getElementById('sensitivitySlider').addEventListener('input', function (e) {
            sensitivity = parseFloat(e.target.value);
            tiltSensitivity = sensitivity / 2;
            document.getElementById('sensitivityValue').textContent = 'x' + sensitivity.toFixed(1);
            log(`感度を${sensitivity.toFixed(1)}倍に変更`);
        });

        // タブ切り替え
        function switchTab(tabName) {
            currentTab = tabName;
            document.querySelectorAll('.tab').forEach(tab => tab.classList.toggle('active', tab.dataset.tab === tabName));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(tabName + 'Content').classList.add('active');
            log(`タブを${tabName}に切り替えました`);
        }

        document.querySelectorAll('.tab').forEach(tab => tab.addEventListener('click', () => switchTab(tab.dataset.tab)));

        // ステータス更新
        function updateStatus(message, type) {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = 'status ' + type;
            log(`ステータス: ${message} (${type})`);
        }

        // 環境情報を記録
        function logEnvironment() {
            log('=== 環境情報 ===');
            log('UA: ' + navigator.userAgent.substring(0, 50) + '...');
            log('DeviceMotionEvent: ' + ('DeviceMotionEvent' in window ? 'あり' : 'なし'));
            if (window.DeviceMotionEvent && window.DeviceMotionEvent.requestPermission) {
                log('requestPermission: あり（iOS 13+）');
            }
        }

        // === 傾きセンサー関連 ===
        function updateProgressBar(elementId, value, max = 10) {
            const progress = document.getElementById(elementId);
            if (!progress) return;
            const percentage = Math.min(Math.abs(value) / max * 50, 50);
            progress.style.width = percentage + '%';
            progress.style.transform = value >= 0 ? 'translateX(0)' : 'translateX(-100%)';
        }

        function update3DDevice(x, y) {
            const device = document.getElementById('device3d');
            if (!device) return;
            const rotateX = -y * 3 * tiltSensitivity;
            const rotateY = x * 3 * tiltSensitivity;
            device.style.transform = `rotateX(${rotateX}deg) rotateY(${rotateY}deg)`;
        }

        function updateTiltBubble(x, y) {
            const bubble = document.getElementById('tiltBubble');
            if (!bubble) return;
            const maxOffset = 55;
            const offsetX = (x / 10) * maxOffset * tiltSensitivity;
            const offsetY = (y / 10) * maxOffset * tiltSensitivity;
            bubble.style.transform = `translate(calc(-50% + ${offsetX}px), calc(-50% + ${offsetY}px))`;
        }

        // === ダウジング関連 ===
        /**
         * @description 線形加速度（重力を除いた動き）の変化量を計算する
         * @param {object} linearAccel - {x, y, z} の線形加速度オブジェクト
         * @returns {number} - 単位時間あたりの加速度変化の大きさ
         */
        function calculateMotionMagnitude(linearAccel) {
            linearAccelerationHistory.push({ ...linearAccel, time: Date.now() });
            const timeLimit = Date.now() - 500;
            linearAccelerationHistory = linearAccelerationHistory.filter(data => data.time > timeLimit);
            if (linearAccelerationHistory.length < 2) return 0;

            let totalChange = 0;
            for (let i = 1; i < linearAccelerationHistory.length; i++) {
                const prev = linearAccelerationHistory[i - 1];
                const curr = linearAccelerationHistory[i];
                const deltaX = curr.x - prev.x;
                const deltaY = curr.y - prev.y;
                const deltaZ = curr.z - prev.z;
                totalChange += Math.sqrt(deltaX * deltaX + deltaY * deltaY + deltaZ * deltaZ);
            }
            return totalChange / (linearAccelerationHistory.length - 1);
        }


        /**
         * 物理シミュレーションを更新 (60fpsで呼び出される)
         * 静止状態を検出し、中心への収束を促すロジックを含む
         */
        function updatePendulumPhysics() {
            const dt = 1.0; // 時間ステップは1として、係数側で調整

            // 感度に応じてパラメータを調整
            const DAMPING = BASE_DAMPING - (sensitivity - 2) * 0.001; // 感度が高いほど減衰が弱い
            const MAX_ANGLE = BASE_MAX_ANGLE + (sensitivity - 2) * 1.5; // 感度が高いほど大きく揺れる

            // 現在の角速度の絶対値の合計で動きの有無を判定
            const currentSpeed = Math.abs(pendulumVelocityX) + Math.abs(pendulumVelocityY);

            if (currentSpeed < MOVEMENT_THRESHOLD) {
                stillnessCounter++;
                // 一定時間、動きが少ない状態が続いたら、中心に引き寄せる
                if (stillnessCounter > STILLNESS_THRESHOLD) {
                    pendulumForceX -= pendulumAngleX * CENTER_PULL_FORCE;
                    pendulumForceY -= pendulumAngleY * CENTER_PULL_FORCE;
                    pendulumForceZ -= pendulumAngleZ * CENTER_PULL_FORCE * 0.5; // 捻りは弱め
                }
            } else {
                stillnessCounter = 0; // 動きがあれば静止カウンターをリセット
            }

            // 感度に応じて復元力を調整（高感度ほど弱く）
            const adjustedSpringConstant = SPRING_CONSTANT / (1 + (sensitivity - 2) * 0.05);

            // --- X軸方向の運動 (F = -kx - cv) ---
            const restoringForceX = -adjustedSpringConstant * pendulumAngleX;
            const totalForceX = pendulumForceX + restoringForceX;
            pendulumVelocityX = (pendulumVelocityX + totalForceX * dt) * DAMPING;
            pendulumAngleX += pendulumVelocityX * dt;

            // --- Y軸方向の運動 ---
            const restoringForceY = -adjustedSpringConstant * pendulumAngleY;
            const totalForceY = pendulumForceY + restoringForceY;
            pendulumVelocityY = (pendulumVelocityY + totalForceY * dt) * DAMPING;
            pendulumAngleY += pendulumVelocityY * dt;

            // --- Z軸(捻り)方向の運動 ---
            const restoringForceZ = -adjustedSpringConstant * 0.5 * pendulumAngleZ;
            const totalForceZ = pendulumForceZ + restoringForceZ;
            pendulumVelocityZ = (pendulumVelocityZ + totalForceZ * dt) * DAMPING;
            pendulumAngleZ += pendulumVelocityZ * dt;

            // 角度を制限
            const totalAngle = Math.sqrt(pendulumAngleX * pendulumAngleX + pendulumAngleY * pendulumAngleY);
            if (totalAngle > MAX_ANGLE) {
                const scale = MAX_ANGLE / totalAngle;
                pendulumAngleX *= scale;
                pendulumAngleY *= scale;
            }
            pendulumAngleZ = Math.max(-90, Math.min(90, pendulumAngleZ)); // 捻り角度を制限

            // 外力を徐々に減衰させる
            pendulumForceX *= 0.9;
            pendulumForceY *= 0.9;
            pendulumForceZ *= 0.9;

            // 表示を更新
            updatePendulumDisplay();
        }

        /**
         * 物理計算の結果をDOMに反映させる
         */
        function updatePendulumDisplay() {
            const pendulumChain = document.getElementById('pendulumChain');
            const pendulumShadow = document.getElementById('pendulumShadow');
            if (!pendulumChain || !pendulumShadow) return;

            // 3軸の回転を適用（Z軸の捻りを追加）
            pendulumChain.style.transform = `rotateX(${pendulumAngleY}deg) rotateY(${-pendulumAngleX}deg) rotateZ(${pendulumAngleZ}deg)`;

            // 影の位置を計算
            const chainLength = 220;
            const shadowOffsetX = chainLength * Math.sin(-pendulumAngleX * Math.PI / 180);
            const shadowOffsetY = chainLength * Math.sin(pendulumAngleY * Math.PI / 180) * Math.sin(60 * Math.PI / 180);

            // 影のスケールと不透明度を調整
            const shadowDist = Math.sqrt(shadowOffsetX * shadowOffsetX + shadowOffsetY * shadowOffsetY);
            const maxShadowDist = 80;
            const shadowScale = Math.max(0.4, 1 - shadowDist / (maxShadowDist * 2));
            const shadowOpacity = Math.max(0.1, 0.5 - shadowDist / maxShadowDist);

            pendulumShadow.style.transform = `translateX(calc(-50% + ${shadowOffsetX}px)) translateY(${shadowOffsetY}px) rotateX(90deg) scale(${shadowScale})`;
            pendulumShadow.style.opacity = shadowOpacity;

            // チャートハイライト
            updateChartHighlight(pendulumAngleX, pendulumAngleY);

            // 真上視点を更新
            updateTopDownView(pendulumAngleX, pendulumAngleY);
        }

        /**
         * ペンデュラムに外力を加える
         * 現在のタブ（モード）に応じて、加速度センサーの入力を力のマッピングに変換する
         */
        function updatePendulum(linearAccel) {
            // 感度に応じて外力のスケールを非線形に調整
            const forceScale = 0.1 * Math.pow(sensitivity / 2, 1.2);

            if (currentTab === 'dowsing') {
                // 「ダウジング」モード：スマホは地面と垂直
                // Y軸の加速度（上下）を、ペンデュラムのX軸の力（左右）に
                pendulumForceX += linearAccel.y * forceScale;
                // Z軸の加速度（前後）を、ペンデュラムのY軸の力（前後）に
                pendulumForceY += linearAccel.z * forceScale;
                // X軸の加速度（左右）を、ペンデュラムのZ軸の力（捻り）に
                pendulumForceZ += linearAccel.x * forceScale * 0.5;
            } else if (currentTab === 'topDown') {
                // 「真上から見る」モード：スマホは地面と水平
                // X軸の加速度（左右）を、ペンデュラムのX軸の力（左右）に
                pendulumForceX -= linearAccel.x * forceScale;
                // Y軸の加速度（前後）を、ペンデュラムのY軸の力（前後）に
                pendulumForceY += linearAccel.y * forceScale;
                // Z軸の加速度（上下）を、ペンデュラムのZ軸の力（捻り）に
                pendulumForceZ += linearAccel.z * forceScale * 0.5;
            }
        }

        function updateChartHighlight(swingX, swingY) {
            const distance = Math.sqrt(swingX * swingX + swingY * swingY);

            if (distance > 15) {
                updateDetectionStatus('ペンデュラムが動いています', 'strong');
            } else if (stillnessCounter < STILLNESS_THRESHOLD) {
                updateDetectionStatus('動きを検出中...', 'weak');
            } else {
                updateDetectionStatus('中心に収束しました', 'none');
            }
        }

        function updateDetectionLevel(changeLevel) {
            detectionLevel = Math.min(changeLevel * 20 * sensitivity, 100);
            const meterFill = document.getElementById('meterFill');
            const meterText = document.getElementById('meterText');
            if (!meterFill || !meterText) return;
            meterFill.style.width = detectionLevel + '%';
            meterText.textContent = Math.round(detectionLevel) + '%';
        }

        function updateDetectionStatus(text, className) {
            const statusDiv = document.getElementById('detectionStatus');
            if (statusDiv) {
                statusDiv.textContent = text;
                statusDiv.className = 'detection-status ' + className;
            }
        }

        /**
         * 真上視点のバブルの位置を更新する
         */
        function updateTopDownView(angleX, angleY) {
            const bubble = document.getElementById('topDownBubble');
            const line = document.getElementById('topDownLine');
            if (!bubble || !line) return;
            // 表示エリアの半径 - バブルの半径 = 150 - 15 = 135
            const maxOffset = 125;
            // 振れの角度を-1 ~ 1の範囲に正規化し、オフセットを計算
            const offsetX = (angleX / BASE_MAX_ANGLE) * maxOffset;
            const offsetY = (angleY / BASE_MAX_ANGLE) * maxOffset;
            bubble.style.transform = `translate(calc(-50% + ${offsetX}px), calc(-50% + ${offsetY}px))`;

            // SVGの線の終点を更新（中心は150,150）
            const centerX = 150;
            const centerY = 150;
            line.setAttribute('x2', centerX + offsetX);
            line.setAttribute('y2', centerY + offsetY);
        }

        /**
         * センサーデータ処理の中核
         */
        function updateSensorData(x, y, z) {
            // ローパスフィルタで重力ベクトルを推定
            gravity.x = LPF_ALPHA * gravity.x + (1 - LPF_ALPHA) * x;
            gravity.y = LPF_ALPHA * gravity.y + (1 - LPF_ALPHA) * y;
            gravity.z = LPF_ALPHA * gravity.z + (1 - LPF_ALPHA) * z;

            // センサーの値から重力を引いて、動きによる線形加速度を算出
            const linearAcceleration = {
                x: x - gravity.x,
                y: y - gravity.y,
                z: z - gravity.z
            };

            if (currentTab === 'tilt') {
                document.getElementById('xValue').textContent = x.toFixed(2);
                document.getElementById('yValue').textContent = y.toFixed(2);
                document.getElementById('zValue').textContent = z.toFixed(2);
                updateProgressBar('xProgress', x);
                updateProgressBar('yProgress', y);
                updateProgressBar('zProgress', z - 9.8);
                update3DDevice(x, y);
                updateTiltBubble(x, y);
            } else if (currentTab === 'dowsing' || currentTab === 'topDown') {
                // ダウジングと真上視点は同じ物理モデルを共有するが、入力のマッピングが異なる
                updatePendulum(linearAcceleration);
                const motionMagnitude = calculateMotionMagnitude(linearAcceleration);
                updateDetectionLevel(motionMagnitude);
            }
        }

        // センサー開始
        async function startSensor() {
            log('startSensor関数が呼ばれました');
            const button = document.getElementById('startButton');
            button.disabled = true;

            try {
                if (window.DeviceMotionEvent && typeof window.DeviceMotionEvent.requestPermission === 'function') {
                    log('iOS 13+の権限をリクエスト中...');
                    updateStatus('センサーの権限を確認中...', 'waiting');
                    const permission = await window.DeviceMotionEvent.requestPermission();
                    if (permission !== 'granted') throw new Error('権限が拒否されました');
                }

                if (!isListening) {
                    log('devicemotionイベントリスナーを設定中...');
                    let eventCount = 0;
                    let lastUpdate = 0;

                    window.addEventListener('devicemotion', (event) => {
                        eventCount++;
                        if (eventCount === 1) {
                            log('最初のイベントを受信！');
                            document.querySelectorAll('.sensor-data').forEach(el => el.classList.add('active'));
                            updateStatus('センサー動作中 🎯', 'success');
                        }

                        const now = Date.now();
                        if (now - lastUpdate < 100) return;
                        lastUpdate = now;

                        if (event.accelerationIncludingGravity) {
                            const acc = event.accelerationIncludingGravity;
                            updateSensorData(acc.x || 0, acc.y || 0, acc.z || 0);
                        }
                    });

                    isListening = true;
                    log('リスナー設定完了');
                    setTimeout(() => {
                        if (eventCount === 0) {
                            log('警告: 3秒経ってもイベントが来ません');
                            updateStatus('センサーが反応しません。デバイスを動かしてみてください', 'error');
                        }
                    }, 3000);
                }
                button.textContent = '✨ センサー動作中';
                updateStatus('センサーを起動しました', 'success');
            } catch (error) {
                log('エラー: ' + error.message);
                updateStatus('エラー: ' + error.message, 'error');
                button.disabled = false;
            }
        }

        // 初期化
        document.addEventListener('DOMContentLoaded', () => {
            log('ページ読み込み完了');
            logEnvironment();
            const button = document.getElementById('startButton');

            if (!window.DeviceMotionEvent) {
                log('エラー: DeviceMotionEventがサポートされていません');
                updateStatus('このブラウザは加速度センサーに対応していません', 'error');
                button.disabled = true;
                return;
            }

            button.addEventListener('click', () => {
                log('ボタンがクリックされました');
                startSensor();
            });

            // 物理シミュレーションのループを開始
            setInterval(updatePendulumPhysics, 1000 / 60);

            log('初期化完了');
        });
    </script>
</body>

</html>