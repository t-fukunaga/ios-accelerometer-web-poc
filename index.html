<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ãƒ‡ãƒã‚¤ã‚¹å‚¾ãã‚»ãƒ³ã‚µãƒ¼</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 500px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
            font-weight: 600;
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 25px;
            font-size: 14px;
        }

        /* ãƒ‡ãƒãƒƒã‚°æƒ…å ±ãƒˆã‚°ãƒ« */
        .debug-toggle {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.1);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            cursor: pointer;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .debug-toggle:hover {
            background: rgba(0,0,0,0.2);
        }

        .debug-info {
            display: none;
            background: #f8f8f8;
            border: 1px solid #ddd;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            font-size: 12px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 200px;
            overflow-y: auto;
        }

        .debug-info.active {
            display: block;
        }

        /* 3Dãƒ‡ãƒã‚¤ã‚¹è¡¨ç¤º */
        .device-visualizer {
            margin: 30px auto;
            width: 200px;
            height: 200px;
            perspective: 800px;
        }

        .device-3d {
            width: 100%;
            height: 100%;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.1s ease-out;
        }

        .device-face {
            position: absolute;
            width: 120px;
            height: 180px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: 2px solid rgba(255,255,255,0.8);
            border-radius: 15px;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 60px;
            color: rgba(255,255,255,0.9);
            box-shadow: 0 0 30px rgba(102, 126, 234, 0.5);
        }

        /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ */
        .status {
            text-align: center;
            padding: 12px;
            margin-bottom: 20px;
            border-radius: 10px;
            font-weight: 500;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .status.waiting {
            background: #e3f2fd;
            color: #1976d2;
        }

        .status.success {
            background: #e8f5e9;
            color: #388e3c;
        }

        .status.error {
            background: #ffebee;
            color: #d32f2f;
        }

        /* ã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³ */
        .start-button {
            display: block;
            width: 100%;
            padding: 16px;
            font-size: 18px;
            font-weight: 600;
            color: white;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 12px;
            cursor: pointer;
            margin-bottom: 25px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            transition: all 0.3s ease;
        }

        .start-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .start-button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* ã‚»ãƒ³ã‚µãƒ¼ãƒ‡ãƒ¼ã‚¿è¡¨ç¤º */
        .sensor-data {
            display: none;
        }

        .sensor-data.active {
            display: block;
        }

        /* è»¸ã”ã¨ã®ãƒ‡ãƒ¼ã‚¿è¡¨ç¤º */
        .axis-container {
            margin-bottom: 20px;
        }

        .axis-item {
            margin-bottom: 20px;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .axis-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .axis-label {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
            font-size: 18px;
        }

        .axis-icon {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            font-size: 16px;
        }

        .axis-x .axis-icon { background: #e74c3c; }
        .axis-y .axis-icon { background: #2ecc71; }
        .axis-z .axis-icon { background: #3498db; }

        .axis-value {
            font-size: 20px;
            font-weight: 700;
            font-variant-numeric: tabular-nums;
        }

        /* ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ */
        .progress-container {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
            position: relative;
        }

        .progress-bar {
            height: 100%;
            background: currentColor;
            transition: width 0.1s ease-out;
            position: absolute;
            left: 50%;
            transform-origin: left center;
        }

        .axis-x .progress-bar { background: #e74c3c; }
        .axis-y .progress-bar { background: #2ecc71; }
        .axis-z .progress-bar { background: #3498db; }

        /* èª¬æ˜ãƒ†ã‚­ã‚¹ãƒˆ */
        .axis-description {
            font-size: 12px;
            color: #666;
            margin-top: 8px;
        }

        /* å‚¾ãæ–¹å‘ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ */
        .tilt-indicator {
            margin: 20px auto;
            width: 150px;
            height: 150px;
            position: relative;
            background: #f0f0f0;
            border-radius: 50%;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.1);
        }

        .tilt-bubble {
            position: absolute;
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.5);
            transition: all 0.1s ease-out;
        }

        .info {
            font-size: 13px;
            color: #666;
            text-align: center;
            margin-top: 20px;
            line-height: 1.6;
        }
    </style>
</head>
<body>
    <div class="container">
        <button id="debugToggle" class="debug-toggle" title="ãƒ‡ãƒãƒƒã‚°æƒ…å ±">
            ğŸ”§
        </button>

        <h1>ğŸ“± ãƒ‡ãƒã‚¤ã‚¹å‚¾ãã‚»ãƒ³ã‚µãƒ¼</h1>
        <p class="subtitle">ãƒ‡ãƒã‚¤ã‚¹ã‚’å‚¾ã‘ã‚‹ã¨åå¿œã—ã¾ã™</p>
        
        <div id="debugInfo" class="debug-info">
            ãƒ‡ãƒãƒƒã‚°æƒ…å ±ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™...
        </div>

        <div id="status" class="status waiting">
            é–‹å§‹ãƒœã‚¿ãƒ³ã‚’ã‚¿ãƒƒãƒ—ã—ã¦ãã ã•ã„
        </div>

        <button id="startButton" class="start-button">
            ã‚»ãƒ³ã‚µãƒ¼ã‚’é–‹å§‹
        </button>

        <div id="sensorData" class="sensor-data">
            <!-- 3Dãƒ‡ãƒã‚¤ã‚¹è¡¨ç¤º -->
            <div class="device-visualizer">
                <div id="device3d" class="device-3d">
                    <div class="device-face">ğŸ“±</div>
                </div>
            </div>

            <!-- å‚¾ãã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ -->
            <div class="tilt-indicator">
                <div id="tiltBubble" class="tilt-bubble"></div>
            </div>

            <!-- å„è»¸ã®ãƒ‡ãƒ¼ã‚¿ -->
            <div class="axis-container">
                <div class="axis-item axis-x">
                    <div class="axis-header">
                        <div class="axis-label">
                            <div class="axis-icon">X</div>
                            <span>å·¦å³ã®å‚¾ã</span>
                        </div>
                        <div class="axis-value" id="xValue">0.00</div>
                    </div>
                    <div class="progress-container">
                        <div id="xProgress" class="progress-bar"></div>
                    </div>
                    <div class="axis-description">å·¦ã«å‚¾ã‘ã‚‹ â† â†’ å³ã«å‚¾ã‘ã‚‹</div>
                </div>

                <div class="axis-item axis-y">
                    <div class="axis-header">
                        <div class="axis-label">
                            <div class="axis-icon">Y</div>
                            <span>å‰å¾Œã®å‚¾ã</span>
                        </div>
                        <div class="axis-value" id="yValue">0.00</div>
                    </div>
                    <div class="progress-container">
                        <div id="yProgress" class="progress-bar"></div>
                    </div>
                    <div class="axis-description">æ‰‹å‰ã«å‚¾ã‘ã‚‹ â† â†’ å¥¥ã«å‚¾ã‘ã‚‹</div>
                </div>

                <div class="axis-item axis-z">
                    <div class="axis-header">
                        <div class="axis-label">
                            <div class="axis-icon">Z</div>
                            <span>ä¸Šä¸‹ã®å‹•ã</span>
                        </div>
                        <div class="axis-value" id="zValue">0.00</div>
                    </div>
                    <div class="progress-container">
                        <div id="zProgress" class="progress-bar"></div>
                    </div>
                    <div class="axis-description">ä¸‹å‘ã â† â†’ ä¸Šå‘ã</div>
                </div>
            </div>
        </div>

        <div class="info">
            ğŸ’¡ ãƒ‡ãƒã‚¤ã‚¹ã‚’æ§˜ã€…ãªæ–¹å‘ã«å‚¾ã‘ã¦ã¿ã¦ãã ã•ã„<br>
            æ›´æ–°é »åº¦: 100ms
        </div>
    </div>

    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let debugLog = [];
        let isListening = false;
        let debugVisible = false;

        // ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’ç”»é¢ã«è¡¨ç¤º
        function log(message) {
            const now = new Date().toTimeString().split(' ')[0];
            const logMessage = `[${now}] ${message}`;
            debugLog.push(logMessage);
            
            // æœ€æ–°ã®10ä»¶ã®ã¿ä¿æŒ
            if (debugLog.length > 10) {
                debugLog.shift();
            }
            
            const debugDiv = document.getElementById('debugInfo');
            debugDiv.textContent = debugLog.join('\n');
            
            // ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«ã‚‚å‡ºåŠ›
            console.log(logMessage);
        }

        // ãƒ‡ãƒãƒƒã‚°è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
        document.getElementById('debugToggle').addEventListener('click', function() {
            debugVisible = !debugVisible;
            const debugDiv = document.getElementById('debugInfo');
            debugDiv.classList.toggle('active', debugVisible);
            this.textContent = debugVisible ? 'âœ–ï¸' : 'ğŸ”§';
        });

        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
        function updateStatus(message, type) {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = 'status ' + type;
            log(`ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ${message} (${type})`);
        }

        // ç’°å¢ƒæƒ…å ±ã‚’è¨˜éŒ²
        function logEnvironment() {
            log('=== ç’°å¢ƒæƒ…å ± ===');
            log('UA: ' + navigator.userAgent.substring(0, 50) + '...');
            log('Protocol: ' + window.location.protocol);
            log('Host: ' + window.location.host);
            log('DeviceMotionEvent: ' + ('DeviceMotionEvent' in window ? 'ã‚ã‚Š' : 'ãªã—'));
            
            if (window.DeviceMotionEvent && window.DeviceMotionEvent.requestPermission) {
                log('requestPermission: ã‚ã‚Šï¼ˆiOS 13+ï¼‰');
            } else {
                log('requestPermission: ãªã—');
            }
        }

        // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã‚’æ›´æ–°
        function updateProgressBar(elementId, value, max = 10) {
            const progress = document.getElementById(elementId);
            const percentage = Math.min(Math.abs(value) / max * 50, 50);
            
            if (value >= 0) {
                progress.style.width = percentage + '%';
                progress.style.transform = 'translateX(0)';
            } else {
                progress.style.width = percentage + '%';
                progress.style.transform = 'translateX(-100%)';
            }
        }

        // 3Dãƒ‡ãƒã‚¤ã‚¹ã‚’æ›´æ–°
        function update3DDevice(x, y) {
            const device = document.getElementById('device3d');
            const rotateX = -y * 3; // Yè»¸ã®å‚¾ãã‚’Xè»¸å›è»¢ã«
            const rotateY = x * 3;  // Xè»¸ã®å‚¾ãã‚’Yè»¸å›è»¢ã«
            device.style.transform = `rotateX(${rotateX}deg) rotateY(${rotateY}deg)`;
        }

        // å‚¾ããƒãƒ–ãƒ«ã‚’æ›´æ–°
        function updateTiltBubble(x, y) {
            const bubble = document.getElementById('tiltBubble');
            const maxOffset = 55; // æœ€å¤§ç§»å‹•è·é›¢
            const offsetX = (x / 10) * maxOffset;
            const offsetY = (y / 10) * maxOffset;
            bubble.style.transform = `translate(calc(-50% + ${offsetX}px), calc(-50% + ${offsetY}px))`;
        }

        // åŠ é€Ÿåº¦ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
        function updateSensorData(x, y, z) {
            // æ•°å€¤ã‚’æ›´æ–°
            document.getElementById('xValue').textContent = x.toFixed(2);
            document.getElementById('yValue').textContent = y.toFixed(2);
            document.getElementById('zValue').textContent = z.toFixed(2);
            
            // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã‚’æ›´æ–°
            updateProgressBar('xProgress', x);
            updateProgressBar('yProgress', y);
            updateProgressBar('zProgress', z - 9.8); // é‡åŠ›ã‚’è£œæ­£
            
            // 3Dè¡¨ç¤ºã‚’æ›´æ–°
            update3DDevice(x, y);
            
            // å‚¾ããƒãƒ–ãƒ«ã‚’æ›´æ–°
            updateTiltBubble(x, y);
        }

        // ã‚»ãƒ³ã‚µãƒ¼é–‹å§‹
        async function startSensor() {
            log('startSensoré–¢æ•°ãŒå‘¼ã°ã‚Œã¾ã—ãŸ');
            
            const button = document.getElementById('startButton');
            button.disabled = true;
            
            try {
                // iOS 13ä»¥é™ã®æ¨©é™ãƒã‚§ãƒƒã‚¯
                if (window.DeviceMotionEvent && typeof window.DeviceMotionEvent.requestPermission === 'function') {
                    log('iOS 13+ã®æ¨©é™ã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆä¸­...');
                    updateStatus('ã‚»ãƒ³ã‚µãƒ¼ã®æ¨©é™ã‚’ç¢ºèªä¸­...', 'waiting');
                    
                    const permission = await window.DeviceMotionEvent.requestPermission();
                    log('æ¨©é™ã®çµæœ: ' + permission);
                    
                    if (permission !== 'granted') {
                        throw new Error('æ¨©é™ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸ');
                    }
                }
                
                // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
                if (!isListening) {
                    log('devicemotionã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®šä¸­...');
                    
                    let eventCount = 0;
                    let lastUpdate = 0;
                    
                    window.addEventListener('devicemotion', function(event) {
                        eventCount++;
                        
                        // åˆå›ã‚¤ãƒ™ãƒ³ãƒˆã‚’ãƒ­ã‚°
                        if (eventCount === 1) {
                            log('æœ€åˆã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’å—ä¿¡ï¼');
                            document.getElementById('sensorData').classList.add('active');
                            updateStatus('ã‚»ãƒ³ã‚µãƒ¼å‹•ä½œä¸­ ğŸ¯', 'success');
                        }
                        
                        // 100msé–“éš”ã§æ›´æ–°
                        const now = Date.now();
                        if (now - lastUpdate < 100) return;
                        lastUpdate = now;
                        
                        // åŠ é€Ÿåº¦ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                        if (event.accelerationIncludingGravity) {
                            const acc = event.accelerationIncludingGravity;
                            updateSensorData(
                                acc.x || 0,
                                acc.y || 0,
                                acc.z || 0
                            );
                        }
                    });
                    
                    isListening = true;
                    log('ãƒªã‚¹ãƒŠãƒ¼è¨­å®šå®Œäº†');
                    
                    // 3ç§’å¾Œã«ã‚¤ãƒ™ãƒ³ãƒˆãŒæ¥ã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                    setTimeout(function() {
                        if (eventCount === 0) {
                            log('è­¦å‘Š: 3ç§’çµŒã£ã¦ã‚‚ã‚¤ãƒ™ãƒ³ãƒˆãŒæ¥ã¾ã›ã‚“');
                            updateStatus('ã‚»ãƒ³ã‚µãƒ¼ãŒåå¿œã—ã¾ã›ã‚“ã€‚ãƒ‡ãƒã‚¤ã‚¹ã‚’å‹•ã‹ã—ã¦ã¿ã¦ãã ã•ã„', 'error');
                        } else {
                            log(`3ç§’é–“ã§${eventCount}å€‹ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’å—ä¿¡`);
                        }
                    }, 3000);
                }
                
                button.textContent = 'âœ¨ ã‚»ãƒ³ã‚µãƒ¼å‹•ä½œä¸­';
                updateStatus('ã‚»ãƒ³ã‚µãƒ¼ã‚’èµ·å‹•ã—ã¾ã—ãŸ', 'success');
                
            } catch (error) {
                log('ã‚¨ãƒ©ãƒ¼: ' + error.message);
                updateStatus('ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
                button.disabled = false;
            }
        }

        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            log('ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†');
            logEnvironment();
            
            const button = document.getElementById('startButton');
            
            // DeviceMotionEventãŒä½¿ãˆã‚‹ã‹ãƒã‚§ãƒƒã‚¯
            if (!window.DeviceMotionEvent) {
                log('ã‚¨ãƒ©ãƒ¼: DeviceMotionEventãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“');
                updateStatus('ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯åŠ é€Ÿåº¦ã‚»ãƒ³ã‚µãƒ¼ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“', 'error');
                button.disabled = true;
                return;
            }
            
            // ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
            button.addEventListener('click', function() {
                log('ãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ');
                startSensor();
            });
            
            log('åˆæœŸåŒ–å®Œäº†');
        });
    </script>
</body>
</html>